---

- name: Настройка параметров sysctl
  sysctl:
      name: net.ipv4.conf.all.forwarding
      value: '1'
      state:  present
      sysctl_set: yes
      reload: yes
  tags:
    - "{{ all_comp }}"

# Установить пакеты, список в переменной "{{ yum_install_all }}"
# Общие пакеты для всех серверов
- name: "Установить пакеты "
  dnf:
    name: "{{ yum_install_all }}"
    state: present
    disable_gpg_check:  yes
  tags:
    - srv01
    - cln01
    - cln02
# yum установка для 7 версии centos
- name: "Установить пакеты yum "
  yum:
    name: "{{ yum_install_all }}"
    state: present
    disable_gpg_check:  yes
  tags:
    - cln05
#Удалить пакеты
## Общие пакеты для всех серверов
- name: "Удалить пакеты "
  dnf:
    name: "{{ yum_remove }}"
    state: absent
  tags:
    - srv01
    - cln01
    - cln02
    
- name: Запуск openVPN на нестандартных портах
  # community.general.seport:
  seport:
    ports: 1195,1196
    proto: udp
    setype: openvpn_port_t
    state: present
  tags:
    - srv01

- name: Создание каталога для логфайлов сервера и клиентов
  file:
    path: /var/log/openvpn/
    state: directory
    owner: openvpn
    group: root
    mode: 0770
  tags:
    - "{{ all_comp }}"

- name: Создание каталога для хранения сертификатов и ключей сервера и клиентов
  file:
    path: /etc/openvpn/cert
    state: directory
    owner: openvpn
    group: root
    mode: 0770
  tags:
    - srv01


- name: Copy keys and certs for servers and clients
  copy:
    src: cert/
    dest: /etc/openvpn/cert/
    owner: openvpn
    group: root
    mode: 0600
  tags:
    - copy_cert
    - srv01


- name: Copy  conf files для запуска нескольких экземпляров openvpn на разных портах и с разными типами интерфейсов (tun tap)
  template:
    src: "{{item.src}}"
    dest: /etc/openvpn/server/{{item.dst}}
    mode: 0600
    owner: openvpn
  loop:
    - {src: '192.168.128.2.conf.j2', dst: '192.168.128.2.conf' }
    - {src: '192.168.160.2.conf.j2', dst: '192.168.160.2.conf' }
    - {src: '192.168.192.2.conf.j2', dst: '192.168.192.2.conf' }
  tags:
    - srv01



- name: Copy cln01(02).conf.j2 files to  cln01.conf и cln02.conf
  template:
    src: "{{ ansible_hostname }}.conf.j2"
    dest: "/etc/openvpn/client/{{ ansible_hostname }}.conf"
    owner: openvpn
    group: root
    mode: 0640
  tags:
    - cln01
    - cln02


#Управление сервисами
## Включить в автозагрузку и запустить необходимые приложения
- name: Enable and started open-vpn
  systemd:
    name: openvpn-server@{{ item.src }}
    state: started
    enabled: yes
  loop:
    - {src: '192.168.128.2'}
    - {src: '192.168.160.2'}
    - {src: '192.168.192.2'}
  tags:
    - srv01

## Включить в автозагрузку и запустить openvpn на клиентах
- name: Enable and started openvpn on clients
  systemd:
    name: openvpn-client@{{ ansible_hostname }}
    state: started
    enabled: yes
  tags:
    - cln01
    - cln02

## Переконфигурирование параметров сетевых карт, создание моста, включение в мост локального интерфеса, тунельного интерфейса, установка значений ebtables для работы туннеля на L2 уровне.srv01
- name: Конфигурация сетевых интерфейсов для работы через туннель. srv01
  # ignore_errors: yes
  script: net_conf_bridge_srv01.sh
  tags:
    - srv01

- name: "Конфигурирование клиента для сети с srv01. Тестирование доступа через туннели"
  script: cln05.sh
  tags:
    - cln05
